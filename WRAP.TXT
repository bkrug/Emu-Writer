       DEF  WRAP
       REF  LINLST,FMTLST,MGNLST
       REF  BUFALC,BUFCPY,BUFREE
       REF  ARYINS,ARYDEL,ARYADR
* Workspace
       REF  WRAPSP
* Constants
       REF  SPACE,DASH,LF,CR,BLKUSE
* Variables
*
       REF  CPL
* Index within Line List of line being
* wrapped
       REF  WRPLN
* Same as WRPLN accept that WRPLNR
* stores an address in the line list.
* The word at WRPLNR's address is in
* turn the address of a line.
       REF  WRPLNR
* Address of unified line.
       REF  UNIADR
* Size
       REF  UNIEND
* Last address within the line list that
* points to this same paragraph.
* Therefore, also the last entry that
* can be copied over.
       REF  FINLIN
* Count the number of new lines inserted
       REF  INSCNT

* Maximum width of a 4 inch line
LNWDTH DATA 120*4
* Character Width in n/120-inch
* 10 cpi
CPI10  DATA 12

*
* Wrap
*
* Input:
* R0 - Line index. Wrap from here.
* Output:
* R0 - >FFFF implies an error.
WRAP   DATA WRAPSP,WRAP+4
*
* Get index of starting line.
       MOV  *R13,@WRPLN
* Get address in paragraph list
       MOV  *R13,R0
       BLWP @ARYADR
       MOV  R0,@WRPLNR
* Find Characters Per Line
       CLR  R2
       MOV  @LNWDTH,R3
       DIV  @CPI10,R2
       MOV  R2,@CPL
*
WRAP2
*  BL   @FNDBRK
*       INC  @WRPLN
*       INCT @WRPLNR
*       JL   WRAP2
*
       RTWP

*
* Find Break
*
FNDBRK
* Point R2 to one line's width later
* than position of R10
       MOV  @CPL,R2
       A    R10,R2
* Is R2 past end of paragraph?
       C    R2,@UNIEND
       JHE  FND5
*
       CB   *R2,@SPACE
       JEQ  FND2
* Find last invisible character in early
* line
FND1   DEC  R2
       CB   *R2,@SPACE
       JEQ  FND3
       CB   *R2,@DASH
       JEQ  FND3
       JMP  FND1
* Find first visible character in next
* line
FND2   INC  R2
       CB   *R2,@SPACE
       JEQ  FND2
       JMP  FND4
FND3   INC  R2
* Save break address in R8
FND4   MOV  R2,R8
       RT
* All remaining characters fit on one
* line.
FND5   MOV  @UNIEND,R8
       RT

WRPERR MOV  R0,*R13
       RTWP

       END