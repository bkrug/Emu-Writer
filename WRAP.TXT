       DEF  WRAP
*
       REF  LINLST,FMTLST,MGNLST
       REF  BUFREE
       REF  ARYALC,ARYADD,ARYADR
* Workspace
       REF  WRAPSP
* Constants
       REF  SPACE,DASH
* Variables
       REF  FMTLEN,FMTEND

* Maximum width of a 4 inch line
LNWDTH DATA 120*4

*
* Wrap
*
* Input:
* R0 - Line index. Wrap from here.
* Output:
* R0 - >FFFF implies an error.
*
WRAP   DATA WRAPSP,WRAP+4
*
* Let R8 hold the the current char width
* Let R9 hold the the next char change
* Let FMTEND hold the address following
*     the format list
       MOV  @FMTLST,R9
       MOV  *R9,R8
       JEQ  FMT3
       SLA  R8,3
       C    *R9+,*R9+
       A    R9,R8
       MOV  R8,@FMTEND
* Move backwards through format list
* Find the entry for the begining of our
* target paragraph, or the last entry
* of a previous paragraph.
FMT1   S    @FMTLEN,R8
       C    R8,R9
       JL   FMT4
       C    *R8,*R13
       JH   FMT1
       JL   FMT2
       MOV  @2(R8),@2(R8)
       JNE  FMT1
* We found current format
FMT2   MOV  R8,R9
       A    @FMTLEN,R9
       AI   R8,6
       MOV  *R8,R8
       JMP  FMT5
* The format list is empty
FMT3   C    *R9+,*R9+
       MOV  R9,@FMTEND
       CLR  R9
* There is no previous format
FMT4   LI   R8,12
* R8, R9, and FMTEND now have required values
FMT5


*
* Let R2 hold character length of each
*    line.
* Let R3 hold address of beginning of a
*    line within the paragraph.
* Let R4 hold address of beginning of
*    the following line
* Let R5 hold begining of paragraph text
* Let R6 hold address of new wrap list.
* Let R7 hold the address past the end
*    of the paragraph.
*
* characters per line
       CLR  R2
       MOV  @LNWDTH,R3
       DIV  R8,R2
* address of paragraph text
       MOV  @LINLST,R0
       MOV  *R13,R1
       BLWP @ARYADR
       MOV  R1,R5
       MOV  *R5,R5
       MOV  *R5,R7               Put character length in R7
       C    *R5+,*R5+            Skip paragraph header
* address of begginng of line
       MOV  R5,R3
* address after end of paragraph
       A    R5,R7
* Create new wrap list and save address
       LI   R0,1
       BLWP @ARYALC
       CI   R0,>FFFF
       JEQ  WRPERR
       MOV  R0,R6


*
* Populate New Wrap List
*
       MOV  R3,R4
WRP0   A    R2,R4
* Is R4 past end of paragraph?
       C    R4,R7
       JHE  WRP5
*
       CB   *R4,@SPACE
       JEQ  WRP2
* Find last invisible character in early
* line
WRP1   DEC  R4
       CB   *R4,@SPACE
       JEQ  WRP3
       CB   *R4,@DASH
       JEQ  WRP3
       JMP  WRP1
* Find first visible character in next
* line
WRP2   INC  R4
       C    R4,R7
       JHE  WRP5
       CB   *R4,@SPACE
       JEQ  WRP2
       JMP  WRP4
WRP3   INC  R4
* Put address at end of wrap list
WRP4   MOV  R6,R0
       BLWP @ARYADD
       CI   R0,>FFFF
       JEQ  WRPERR
       MOV  R4,*R1
* Convert from address to string index
       S    R5,*R1
* Do next line in paragraph
       MOV  R4,R3
       JMP  WRP0
* 
* All remaining characters fit on one
* line.
WRP5


* Change R5 from paragraph text address
* to pointer to paragraph's wrap list.
       AI   R5,-2
* Deallocate old wrap list.
       MOV  *R5,R0
       BLWP @BUFREE
* Register new wrap list with paragraph
       MOV  R6,*R5
       RTWP

WRPERR MOV  R0,*R13
       RTWP

       END